<div class="patient-form {{if .ReadOnly}}readonly-mode{{end}}">
    <div class="patient-header">
        <h2>
            {{if .IsEditing}}
            <i class="fas fa-user-edit"></i> Editar Paciente
            {{else if .ReadOnly}}
            <i class="fas fa-user-md"></i> Detalles del Paciente
            {{else}}
            <i class="fas fa-user-plus"></i> Nuevo Paciente
            {{end}}
        </h2>
    </div>

    {{if .Error}}
    <div class="error-message">
        <i class="fas fa-exclamation-circle"></i> {{.Error}}
    </div>
    {{end}}

    <div class="form-tabs">
        <button type="button" class="tab-btn active" data-tab="personal">
            <i class="fas fa-user"></i> Información Personal
        </button>
        <button type="button" class="tab-btn" data-tab="contact">
            <i class="fas fa-address-book"></i> Contacto
        </button>
        <button type="button" class="tab-btn" data-tab="medical">
            <i class="fas fa-notes-medical"></i> Historial Médico
        </button>
        <button type="button" class="tab-btn" data-tab="anthropometric">
            <i class="fas fa-weight"></i> Datos Antropométricos
        </button>
        <button type="button" class="tab-btn" data-tab="lifestyle">
            <i class="fas fa-walking"></i> Estilo de Vida
        </button>
        <button type="button" class="tab-btn" data-tab="specialist">
            <i class="fas fa-stethoscope"></i> Especialidades
        </button>
    </div>

    {{if not .ReadOnly}}<form
        action="{{if .IsEditing}}/pacientes/{{.Paciente.ID}}/editar{{else}}/pacientes/crear{{end}}" method="post">
        {{end}}
        <div class="tab-content">
            <!-- Tab: Información Personal -->
            <div class="tab-pane active" id="personal">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre">Nombre*</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">{{.Paciente.Nombre}}</div>
                        {{else}}
                        <input type="text" id="nombre" name="nombre" value="{{.Paciente.Nombre}}" required>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="apellido">Apellido*</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">{{.Paciente.Apellido}}</div>
                        {{else}}
                        <input type="text" id="apellido" name="apellido" value="{{.Paciente.Apellido}}" required>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha de Nacimiento</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if not .Paciente.FechaNacimiento.IsZero}}
                            {{.Paciente.FechaNacimiento.Format "02/01/2006"}}
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento"
                            value="{{if not .Paciente.FechaNacimiento.IsZero}}{{.Paciente.FechaNacimiento.Format "
                            2006-01-02"}}{{end}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="genero">Género</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Genero}}
                            {{.Paciente.Genero}}
                            {{else}}
                            No especificado
                            {{end}}
                        </div>
                        {{else}}
                        <select id="genero" name="genero">
                            <option value="" {{if eq .Paciente.Genero "" }}selected{{end}}>Seleccionar</option>
                            <option value="Masculino" {{if eq .Paciente.Genero "Masculino" }}selected{{end}}>Masculino
                            </option>
                            <option value="Femenino" {{if eq .Paciente.Genero "Femenino" }}selected{{end}}>Femenino
                            </option>
                            <option value="No binario" {{if eq .Paciente.Genero "No binario" }}selected{{end}}>No
                                binario</option>
                            <option value="Prefiero no decir" {{if eq .Paciente.Genero "Prefiero no decir"
                                }}selected{{end}}>Prefiero no decir</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="estadoCivil">Estado Civil</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.EstadoCivil}}
                            {{.Paciente.EstadoCivil}}
                            {{else}}
                            No especificado
                            {{end}}
                        </div>
                        {{else}}
                        <select id="estadoCivil" name="estadoCivil">
                            <option value="" {{if eq .Paciente.EstadoCivil "" }}selected{{end}}>Seleccionar</option>
                            <option value="Soltero/a" {{if eq .Paciente.EstadoCivil "Soltero/a" }}selected{{end}}>
                                Soltero/a</option>
                            <option value="Casado/a" {{if eq .Paciente.EstadoCivil "Casado/a" }}selected{{end}}>Casado/a
                            </option>
                            <option value="Divorciado/a" {{if eq .Paciente.EstadoCivil "Divorciado/a" }}selected{{end}}>
                                Divorciado/a</option>
                            <option value="Viudo/a" {{if eq .Paciente.EstadoCivil "Viudo/a" }}selected{{end}}>Viudo/a
                            </option>
                            <option value="Unión libre" {{if eq .Paciente.EstadoCivil "Unión libre" }}selected{{end}}>
                                Unión libre</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="ocupacion">Ocupación</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Ocupacion}}
                            {{.Paciente.Ocupacion}}
                            {{else}}
                            No especificada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="ocupacion" name="ocupacion" value="{{.Paciente.Ocupacion}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="nacionalidad">Nacionalidad</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Nacionalidad}}
                            {{.Paciente.Nacionalidad}}
                            {{else}}
                            No especificada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="nacionalidad" name="nacionalidad" value="{{.Paciente.Nacionalidad}}">
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if .ReadOnly}}
                    <a href="/pacientes/{{.Paciente.ID}}/editar" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Editar Paciente
                    </a>
                    {{else}}
                    <button type="button" class="btn btn-primary next-tab" data-next="contact">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    {{end}}
                </div>
            </div>

            <!-- Tab: Información de Contacto -->
            <div class="tab-pane" id="contact">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="telefono">Teléfono Principal</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Telefono}}
                            {{.Paciente.Telefono}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="tel" id="telefono" name="telefono" value="{{.Paciente.Telefono}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="telefonoAlternativo">Teléfono Alternativo</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.TelefonoAlternativo}}
                            {{.Paciente.TelefonoAlternativo}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="tel" id="telefonoAlternativo" name="telefonoAlternativo"
                            value="{{.Paciente.TelefonoAlternativo}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Email}}
                            {{.Paciente.Email}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="email" id="email" name="email" value="{{.Paciente.Email}}">
                        {{end}}
                    </div>
                    <div class="form-group full-width">
                        <label for="direccion">Dirección</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Direccion}}
                            {{.Paciente.Direccion}}
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <textarea id="direccion" name="direccion" rows="2">{{.Paciente.Direccion}}</textarea>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="contactoEmergenciaNombre">Contacto de Emergencia (Nombre)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.ContactoEmergenciaNombre}}
                            {{.Paciente.ContactoEmergenciaNombre}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="contactoEmergenciaNombre" name="contactoEmergenciaNombre"
                            value="{{.Paciente.ContactoEmergenciaNombre}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="contactoEmergenciaTel">Contacto de Emergencia (Teléfono)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.ContactoEmergenciaTel}}
                            {{.Paciente.ContactoEmergenciaTel}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="tel" id="contactoEmergenciaTel" name="contactoEmergenciaTel"
                            value="{{.Paciente.ContactoEmergenciaTel}}">
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if not .ReadOnly}}
                    <button type="button" class="btn btn-secondary prev-tab" data-prev="personal">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary next-tab" data-next="medical">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    {{end}}
                </div>
            </div>

            <!-- Tab: Historial Médico -->
            <div class="tab-pane" id="medical">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="grupoSanguineo">Grupo Sanguíneo</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.GrupoSanguineo}}
                            {{.Paciente.GrupoSanguineo}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <select id="grupoSanguineo" name="grupoSanguineo">
                            <option value="" {{if eq .Paciente.GrupoSanguineo "" }}selected{{end}}>Seleccionar</option>
                            <option value="A+" {{if eq .Paciente.GrupoSanguineo "A+" }}selected{{end}}>A+</option>
                            <option value="A-" {{if eq .Paciente.GrupoSanguineo "A-" }}selected{{end}}>A-</option>
                            <option value="B+" {{if eq .Paciente.GrupoSanguineo "B+" }}selected{{end}}>B+</option>
                            <option value="B-" {{if eq .Paciente.GrupoSanguineo "B-" }}selected{{end}}>B-</option>
                            <option value="AB+" {{if eq .Paciente.GrupoSanguineo "AB+" }}selected{{end}}>AB+</option>
                            <option value="AB-" {{if eq .Paciente.GrupoSanguineo "AB-" }}selected{{end}}>AB-</option>
                            <option value="O+" {{if eq .Paciente.GrupoSanguineo "O+" }}selected{{end}}>O+</option>
                            <option value="O-" {{if eq .Paciente.GrupoSanguineo "O-" }}selected{{end}}>O-</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="numeroSeguro">Número de Seguro</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.NumeroSeguro}}
                            {{.Paciente.NumeroSeguro}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="numeroSeguro" name="numeroSeguro" value="{{.Paciente.NumeroSeguro}}">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="alergias">Alergias</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Alergias}}
                            {{.Paciente.Alergias}}
                            {{else}}
                            No registradas
                            {{end}}
                        </div>
                        {{else}}
                        <textarea id="alergias" name="alergias" rows="2">{{.Paciente.Alergias}}</textarea>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="enfermedadesCronicas">Enfermedades Crónicas</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.EnfermedadesCronicas}}
                            {{.Paciente.EnfermedadesCronicas}}
                            {{else}}
                            No registradas
                            {{end}}
                        </div>
                        {{else}}
                        <textarea id="enfermedadesCronicas" name="enfermedadesCronicas"
                            rows="2">{{.Paciente.EnfermedadesCronicas}}</textarea>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="medicamentosActuales">Medicamentos Actuales</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.MedicamentosActuales}}
                            {{.Paciente.MedicamentosActuales}}
                            {{else}}
                            No registrados
                            {{end}}
                        </div>
                        {{else}}
                        <textarea id="medicamentosActuales" name="medicamentosActuales"
                            rows="2">{{.Paciente.MedicamentosActuales}}</textarea>
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if not .ReadOnly}}
                    <button type="button" class="btn btn-secondary prev-tab" data-prev="contact">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary next-tab" data-next="anthropometric">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    {{end}}
                </div>
            </div>

            <!-- Tab: Datos Antropométricos -->
            <div class="tab-pane" id="anthropometric">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="estatura">Estatura (cm)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if gt .Paciente.Estatura 0}}
                            {{.Paciente.Estatura}} cm
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="number" id="estatura" name="estatura" step="0.01" value="{{.Paciente.Estatura}}"
                            min="0" max="300">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="peso">Peso (kg)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if gt .Paciente.Peso 0}}
                            {{.Paciente.Peso}} kg
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="number" id="peso" name="peso" step="0.1" value="{{.Paciente.Peso}}" min="0"
                            max="500">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="imc">IMC (kg/m²)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if gt .Paciente.IMC 0}}
                            {{.Paciente.IMC}}
                            {{if lt .Paciente.IMC 18.5}}
                            <span class="badge badge-warning">Bajo peso</span>
                            {{else if lt .Paciente.IMC 25}}
                            <span class="badge badge-success">Normal</span>
                            {{else if lt .Paciente.IMC 30}}
                            <span class="badge badge-warning">Sobrepeso</span>
                            {{else}}
                            <span class="badge badge-danger">Obesidad</span>
                            {{end}}
                            {{else}}
                            No calculado
                            {{end}}
                        </div>
                        {{else}}
                        <input type="number" id="imc" name="imc" step="0.01" value="{{.Paciente.IMC}}" readonly>
                        <div class="form-text" id="imcResult"></div>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="circunferenciaCintura">Circunferencia de Cintura (cm)</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if gt .Paciente.CircunferenciaCintura 0}}
                            {{.Paciente.CircunferenciaCintura}} cm
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="number" id="circunferenciaCintura" name="circunferenciaCintura" step="0.1"
                            value="{{.Paciente.CircunferenciaCintura}}" min="0">
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if not .ReadOnly}}
                    <button type="button" class="btn btn-secondary prev-tab" data-prev="medical">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary next-tab" data-next="lifestyle">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    {{end}}
                </div>
            </div>

            <!-- Tab: Estilo de Vida -->
            <div class="tab-pane" id="lifestyle">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tabaquismo">Tabaquismo</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.Tabaquismo}}
                            {{.Paciente.Tabaquismo}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <select id="tabaquismo" name="tabaquismo">
                            <option value="" {{if eq .Paciente.Tabaquismo "" }}selected{{end}}>Seleccionar</option>
                            <option value="No fumador" {{if eq .Paciente.Tabaquismo "No fumador" }}selected{{end}}>No
                                fumador</option>
                            <option value="Ex-fumador" {{if eq .Paciente.Tabaquismo "Ex-fumador" }}selected{{end}}>
                                Ex-fumador</option>
                            <option value="Fumador ocasional" {{if eq .Paciente.Tabaquismo "Fumador ocasional"
                                }}selected{{end}}>Fumador ocasional</option>
                            <option value="Fumador diario" {{if eq .Paciente.Tabaquismo "Fumador diario"
                                }}selected{{end}}>Fumador diario</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="consumoAlcohol">Consumo de Alcohol</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.ConsumoAlcohol}}
                            {{.Paciente.ConsumoAlcohol}}
                            {{else}}
                            No registrado
                            {{end}}
                        </div>
                        {{else}}
                        <select id="consumoAlcohol" name="consumoAlcohol">
                            <option value="" {{if eq .Paciente.ConsumoAlcohol "" }}selected{{end}}>Seleccionar</option>
                            <option value="No consume" {{if eq .Paciente.ConsumoAlcohol "No consume" }}selected{{end}}>
                                No consume</option>
                            <option value="Ocasional" {{if eq .Paciente.ConsumoAlcohol "Ocasional" }}selected{{end}}>
                                Ocasional</option>
                            <option value="Moderado" {{if eq .Paciente.ConsumoAlcohol "Moderado" }}selected{{end}}>
                                Moderado</option>
                            <option value="Frecuente" {{if eq .Paciente.ConsumoAlcohol "Frecuente" }}selected{{end}}>
                                Frecuente</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="actividadFisica">Actividad Física</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.ActividadFisica}}
                            {{.Paciente.ActividadFisica}}
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <select id="actividadFisica" name="actividadFisica">
                            <option value="" {{if eq .Paciente.ActividadFisica "" }}selected{{end}}>Seleccionar</option>
                            <option value="Sedentario" {{if eq .Paciente.ActividadFisica "Sedentario" }}selected{{end}}>
                                Sedentario</option>
                            <option value="Ligera" {{if eq .Paciente.ActividadFisica "Ligera" }}selected{{end}}>Ligera
                            </option>
                            <option value="Moderada" {{if eq .Paciente.ActividadFisica "Moderada" }}selected{{end}}>
                                Moderada</option>
                            <option value="Intensa" {{if eq .Paciente.ActividadFisica "Intensa" }}selected{{end}}>
                                Intensa</option>
                        </select>
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="horasSueño">Horas de Sueño</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.HorasSueño}}
                            {{.Paciente.HorasSueño}}
                            {{else}}
                            No registradas
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="horasSueño" name="horasSueño" value="{{.Paciente.HorasSueño}}"
                            placeholder="Ej: 7-8 horas">
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if not .ReadOnly}}
                    <button type="button" class="btn btn-secondary prev-tab" data-prev="anthropometric">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary next-tab" data-next="specialist">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    {{end}}
                </div>
            </div>

            <!-- Tab: Especialidades Médicas -->
            <div class="tab-pane" id="specialist">
                <div class="form-grid">
                    <!-- Nutrición -->
                    <div class="form-group full-width">
                        <h4><i class="fas fa-apple-alt"></i> Nutrición</h4>
                    </div>
                    <div class="form-group">
                        <label for="restriccionesDieteticas">Restricciones Dietéticas</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.RestriccionesDieteticas}}
                            {{.Paciente.RestriccionesDieteticas}}
                            {{else}}
                            No registradas
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="restriccionesDieteticas" name="restriccionesDieteticas"
                            value="{{.Paciente.RestriccionesDieteticas}}" placeholder="Ej: Sin gluten, sin lactosa">
                        {{end}}
                    </div>
                    <div class="form-group">
                        <label for="cambiosPeso">Cambios de Peso Recientes</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.CambiosPeso}}
                            {{.Paciente.CambiosPeso}}
                            {{else}}
                            No registrados
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="cambiosPeso" name="cambiosPeso" value="{{.Paciente.CambiosPeso}}"
                            placeholder="Ej: Pérdida de 5kg en 3 meses">
                        {{end}}
                    </div>

                    <!-- Cardiología -->
                    <div class="form-group full-width">
                        <h4><i class="fas fa-heartbeat"></i> Cardiología</h4>
                    </div>
                    <div class="form-group">
                        <label for="presionArterialHabitual">Presión Arterial Habitual</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.PresionArterialHabitual}}
                            {{.Paciente.PresionArterialHabitual}}
                            {{else}}
                            No registrada
                            {{end}}
                        </div>
                        {{else}}
                        <input type="text" id="presionArterialHabitual" name="presionArterialHabitual"
                            value="{{.Paciente.PresionArterialHabitual}}" placeholder="Ej: 120/80">
                        {{end}}
                    </div>

                    <!-- Notas Generales -->
                    <div class="form-group full-width">
                        <label for="notasMedicas">Notas Médicas</label>
                        {{if .ReadOnly}}
                        <div class="readonly-value">
                            {{if .Paciente.NotasMedicas}}
                            {{.Paciente.NotasMedicas}}
                            {{else}}
                            No hay notas registradas
                            {{end}}
                        </div>
                        {{else}}
                        <textarea id="notasMedicas" name="notasMedicas" rows="4">{{.Paciente.NotasMedicas}}</textarea>
                        {{end}}
                    </div>
                </div>

                <div class="tab-actions">
                    {{if .ReadOnly}}
                    <div class="actions-group">
                        <a href="/pacientes/{{.Paciente.ID}}/editar" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <a href="/citas/crear?paciente={{.Paciente.ID}}" class="btn btn-success">
                            <i class="fas fa-calendar-plus"></i> Programar Cita
                        </a>
                        <a href="/pacientes" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                    </div>
                    {{else}}
                    <button type="button" class="btn btn-secondary prev-tab" data-prev="lifestyle">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> {{if .IsEditing}}Guardar Cambios{{else}}Crear Paciente{{end}}
                    </button>
                    {{end}}
                </div>
            </div>
        </div>
        {{if not .ReadOnly}}
    </form>{{end}}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Selector de tabs
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const tab = this.getAttribute('data-tab');

                // Remover clase activa de todos los botones y pestañas
                tabBtns.forEach(b => b.classList.remove('active'));
                tabPanes.forEach(p => p.classList.remove('active'));

                // Añadir clase activa al botón y pestaña seleccionados
                this.classList.add('active');
                document.getElementById(tab).classList.add('active');
            });
        });

        // Navegación de tabs con botones siguiente/anterior
        const nextBtns = document.querySelectorAll('.next-tab');
        const prevBtns = document.querySelectorAll('.prev-tab');

        nextBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const nextTab = this.getAttribute('data-next');

                // Simular click en el botón de la pestaña correspondiente
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${nextTab}"]`);
                tabBtn.click();
            });
        });

        prevBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const prevTab = this.getAttribute('data-prev');

                // Simular click en el botón de la pestaña correspondiente
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${prevTab}"]`);
                tabBtn.click();
            });
        });

        // Cálculo automático del IMC cuando se ingresan peso y estatura
        const pesoInput = document.getElementById('peso');
        const estaturaInput = document.getElementById('estatura');
        const imcInput = document.getElementById('imc');
        const imcResultDiv = document.getElementById('imcResult');

        function calcularIMC() {
            if (pesoInput && estaturaInput && pesoInput.value && estaturaInput.value) {
                const peso = parseFloat(pesoInput.value);
                const estatura = parseFloat(estaturaInput.value) / 100; // convertir a metros
                if (peso > 0 && estatura > 0) {
                    const imc = peso / (estatura * estatura);
                    if (imcInput) imcInput.value = imc.toFixed(2);

                    // Clasificación del IMC
                    let clasificacion = '';
                    let color = '';

                    if (imc < 18.5) {
                        clasificacion = 'Bajo peso';
                        color = '#3498db';
                    } else if (imc < 25) {
                        clasificacion = 'Peso normal';
                        color = '#2ecc71';
                    } else if (imc < 30) {
                        clasificacion = 'Sobrepeso';
                        color = '#f39c12';
                    } else {
                        clasificacion = 'Obesidad';
                        color = '#e74c3c';
                    }

                    if (imcResultDiv) {
                        imcResultDiv.textContent = clasificacion;
                        imcResultDiv.style.color = color;
                    }
                }
            }
        }

        if (pesoInput && estaturaInput) {
            pesoInput.addEventListener('input', calcularIMC);
            estaturaInput.addEventListener('input', calcularIMC);
            // Calcular IMC inicial
            calcularIMC();
        }

        // Calculadora de índice cintura-cadera
        const cinturaInput = document.getElementById('circunferenciaCintura');
        const caderaInput = document.getElementById('circunferenciaCadera');
        const indiceCCInput = document.getElementById('relacionCinturaCadera');

        function calcularIndiceCC() {
            if (cinturaInput && caderaInput && cinturaInput.value && caderaInput.value) {
                const cintura = parseFloat(cinturaInput.value);
                const cadera = parseFloat(caderaInput.value);
                if (cintura > 0 && cadera > 0 && indiceCCInput) {
                    const indiceCC = cintura / cadera;
                    indiceCCInput.value = indiceCC.toFixed(2);
                }
            }
        }

        if (cinturaInput && caderaInput && indiceCCInput) {
            cinturaInput.addEventListener('input', calcularIndiceCC);
            caderaInput.addEventListener('input', calcularIndiceCC);
            // Calcular índice inicial
            calcularIndiceCC();
        }
    });
</script>